# **База данных "Расписание мех-мата"**

- [:lion: Что за зверь?](#что-за-зверь)
- [:thinking: Как запустить?](#как-запустить)
- [:pushpin: Модель данных](#модель-данных)
- [:gift: Поддерживаемые операции](#операции)
- [:pencil2: Синтаксис запросов](#синтаксис)
- [:ledger: Протокол взаимодействия клиента и сервера](#протокол)
- [:gear: Что под капотом?](#под-капотом)
- [:test_tube: Тестирование](#тестирование)

<a name="что-за-зверь"></a> 
## :lion: Что за зверь?

Этот проект предоставляет мощный инструмент для создания и редактирования расписания в учебных
заведениях. С его помощью можно, например, оперативно внести изменения в текущий график жизни
факультета или получить выборку интересующих ячеек расписания.

Сервер поддерживает опцию одновременного подключения сразу нескольких клиентов. Это позволяет
нескольким людям работать с данными одновременно, что является необходимым требованием для
обеспечения комфортной работы с расписаниями больших факультетов или даже университетов.
Благодаря ~~нехитрым~~ нетривиальным алгоритмам, даже при работе с разросшейся базой данных
пользователь не будет испытывать проблем со временем ожидания ответа на свой запрос.

Вместе с самой базой данных и сервером, в проект входит дефолтная клиентская программа.
Вы можете реализовать свои клиент-программы, которые позволят Вам работать с удобным представлением
данных, при этом ничего не меняя в коде сервера и самой базы данных.

<a name="как-запустить"></a> 
___
## :thinking: Как запустить?

Чтобы всё прошло гладко, вам понадобятся:
+ командная оболочка **bash**
+ компилятор **GCC** с поддержкой **C++20**
+ интерпретатор :snake: **python3**

Cобрать проект и запустить сервер можно командой:

```
make
```

Если необходимо лишь получить исполняемый файл **runme**, то следует воспользоваться командой

```
make runme
```

Клиент запускается командой

```
python3 client.py
```

Наконец, для очистки папки **_./ObjectFiles_** и удаления файла **runme** используйте

```
make clean
```

:white_check_mark: При запуске сервер заполняет базу данных записями из файла **_./data.txt_**.
После завершения работы все записи сохраняются в этом же файле. В нём построчно перечислены
все имеющиеся данные в формате\
"_teacher; subject; room; day; period; group;_" (см. [модель данных](#модель-данных))

<a name="модель-данных"></a> 
___
## :pushpin: Модель данных

Отдельная запись по расписанию содержит следующие поля:
+ `day` - день недели - целое число в фиксированном диапазоне
+ `period` - номер пары - целое число в фиксированном диапазоне
+ `room` - номер аудитории - целое число в фиксированном диапазоне
+ `subject` - название предмета - строка, состоящая исключительно из букв латинского алфавита, точек
  и дефисов
+ `teacher` - имя преподавателя - строка, состоящая исключительно из букв латинского алфавита, точек
  и дефисов
+ `group` - номер группы - целое число в фиксированном диапазоне

:white_check_mark: Диапазоны могут быть изменены путём переопределения чисел напротив соответствующих
макросов в файле [./TaskStructures/task_structures.h](TaskStructures/task_structures.h)

<a name="операции"></a> 
___
## :gift: Поддерживаемые операции

При работе с базой данных, пользователь может использовать следующие команды:
+ `insert` - добавить новый пункт в расписание с проверкой возможных накладок
+ `remove` - удалить пункты, соответствующие заданным критериям
+ `select` - произвести выборку по указанным критериям
+ `reselect` - произвести выборку из уже выбранных записей
+ `print` - вывести результат выборки
  + `sort` - отсортировать предназначенные для вывода записи в нужном порядке
+ `stop` - отключиться от сервера
+ `shutdown` - завершить работу сервера

<a name="синтаксис"></a> 
___
## :pencil2: Синтаксис запросов

Для формулировки запросов используется специальный язык, в котором задаются действия и критерии
выборки. Он довольно примитивен и поэтому прост в освоении. Вот его основные правила:
1. Первое слово запроса является названием одной из семи операций, описанных [выше](#операции).

2. Далее через пробел указываются параметры запроса. Их вид зависит от конкретной операции:

    1.  `stop`, `shutdown`

        Эти запросы выполняются без параметров.
   
    2.  `print`

        Параметры являются названиями полей, которые будут выведены при печати в порядке
        перечисления. Поля могут повторяться - в этом случае вывод будет содержать несколько
        вхождений одной и той же информации. После того, как необходимые поля перечислены, можно
        указать опцию сортировки `sort`. Аналогично `print`, вслед за ней следует пречислить поля,
        по которым будет производится сортировка в порядке их указания.\
        Например, следующий запрос позволит получить отсортированный по номеру группы список
        отобранных записей, содержащий имя преподавателя и продублированный номер аудитории:

        ```
        print teacher room room sort group
        ```

    3.  `insert`

        Каждый параметр представляет собой имя поля и его значение, написанное
        через знак `=` **без пробелов**.\
        Пример перед Вами:

        ```
        insert teacher=G.I.Khomutov subject=Statistics room=426 day=3 period=2 group=210
        ```
        
        :exclamation: _Обратите внимание, что для добавления пункта в расписание необходимо задать
        **все** поля без исключения._

    4.  `remove`, `select`, `reselect`

        Каждый параметр представляет собой имя поля и его значение,
        указанное либо в точности, либо в виде диапазона (для числовых полей), либо в форме
        "_начинается с чего-то_" (для строковых полей).\
        Для этого вводится специальный символ `*`, который обозначает произвольное продолжение
        строки или же отсутствие границы диапазона.\
        Например, можно выбрать занятия, проходящие у групп с номерами не меньше 400 в аудитории 77
        под руководством преподавателя, чьё имя начинается на букву _A_:
        ```
        select teacher=A* group=400-* room=77
        ```

:white_check_mark: Названия команд и имена полей можно писать в произвольном регистре. Также
количество пробелов между токенами запроса не имеет никакого значения, важно лишь их наличие.

<a name="протокол"></a> 
___
## :ledger: Протокол взаимодействия клиента и сервера

Получив строку запроса от пользователя, клиент сначала передаёт на сервер длину запроса, а затем 
сам запрос.

В ответ от сервера приходит один из четырёх кодов. Вид последующей информации зависит от
значения этого кода:

+ `0` - была успешно выполнена одна из команд `insert`, `remove`, `select`, `reselect`

    Дальнейшая информация отсутствует.

+ `1` - была успешно выполнена команда `print`

    В этом случае клиент получает количество **N** найденных в базе записей. Далее он
    **N** раз принимает сначала длину очередной записи, а затем саму запись. Она состоит из
    значений указанных в запросе полей, перечисленных через точку с запятой и пробел.\
    То есть в ответ на второй запрос из последовательности

    ```
    select teacher=A* room=455
    print room teacher room
    ```

    клиент может получить, например, такие записи:

    ```
    455; Alex; 455;
    455; Anna; 455;
    ```

+ `2` - была успешно выполнена команда `stop` или `shutdown`

    Дальнейшая информация отсутствует.

+ `3` - при выполнении запроса возникла ошибка

    Сначала передаётся длина сообщения о характере возникшей ошибки, а затем само
    сообщение.

:white_check_mark: Надёжная доставка сообщений обеспечивается протоколом
[TCP](https://www.opennet.ru/docs/RUS/linux_base/node350.html).

<a name="под-капотом"></a> 
____
## :gear: Что под капотом?

> _**Неважно, что у машины под капотом. Самое главное, кто сидит за рулём.** © Доминик Торетто_

После получения строки запроса от клиента, сервер отправляет его базе данных вместе с
идентификатором пользователя. Соответствующий метод класса **_Database_** принимает запрос,
разбирает его при помощи класса **_Query_** (на этом этапе здорово помогает паттерн проектирования
["Фабрика"](https://en.wikipedia.org/wiki/Factory_method_pattern)), а затем вызывает исполнителя.

Основой внутреннего представления данных является разреженная матрица, строки которой
соответствуют времени, а столбцы - аудитории (как у диспетчера). Содержимое ячейки этой матрицы
определяет преподавателя, предмет и группу. Для быстрого поиска расписания конкретного преподавателя
или предмета поддерживаются две соответствующие хэш-таблицы, позволяющие оперативно получать нужные
позиции в разреженной матрице по имени преподавателя или по названию предмета.

> _**В эфире самая огненная среди взрывающихся и самая взрывающаяся среди огненных рубрик программы
["Галилео"](https://www.youtube.com/@GalileoRU/playlists) - "Э-э-эксперименты"!** © Александр Пушной_

Было решено сделать необычный вариант обработки запросов `select` и `reselect`. Они не исполняются
напрямую при каждом запросе, а "накапливаются" в сессии пользователя. Непосредственное выполнение
происходит лишь при получении команды `print` от клиента. 

<a name="тестирование"></a> 
___
## :test_tube: Тестирование

После того, как сервер запущен, можно выполнить проверочные тесты командой

```
make tests
```

Тесты, запускаемые этой командой, можно найти в папке [./TESTING/tests](./TESTING/tests) и при
желании дополнить их своими вариантами.\
Для этого необходимо создать новый файл **newtest.in** и построчно заполнить его запросами.\
Первым запросом следует очистить базу данных, а последним - завершить работу клиента.\
Ожидаемые ответы клиента нужно записать в файл **newtest.res**.\
Тестирующая программа запускает клиент, выполняет запросы и сверяет полученные ответы с ожидаемыми.\
:exclamation: _Обратите внимание, что для корректного тестирования необходима однозначность
представления результатов каждого из запросов._

Также можно устроить нагрузочное тестирование:

```
make stress
```

После выполнения этой команды Вам будет предложено задать начальное количество записей в базе,
а затем - количество запросов, которые будут отправлены серверу.
